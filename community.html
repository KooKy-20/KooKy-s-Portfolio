<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>커뮤니티 | KooKy</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div id="header-placeholder"></div>

<div class="post-box" style="margin-top: 30px;">
  <textarea id="postInput" maxlength="140" placeholder="포트폴리오에 대한 한 마디를 남겨보세요" style="width: 100%; height: 60px;"></textarea>
  <button id="submitBtn">작성</button>
</div>

<ul id="postList" style="margin-top: 20px;"></ul>
  
<script>
  // 공통 헤더 삽입
  fetch('header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header-placeholder').innerHTML = html;

      // 현재 경로에 맞게 메뉴 강조
      const path = location.pathname.split("/").pop();
      document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
        const href = link.getAttribute('href');
        if (href === path || (path === '' && href === 'index.html')) {
          link.classList.add('active');
          link.setAttribute('aria-current', 'page');
        }
      });

      // ✅ 언어 상태 반영 (data-i18n 적용, 버튼 강조 등)
      setLanguage(currentLang);
    });
</script>

  <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const postsRef = collection(db, "communityPosts");

  // 날짜 key (브라우저 기준으로 하루 제한)
  const todayKey = `posted-${new Date().toLocaleDateString()}`;
  if (localStorage.getItem(todayKey)) {
    document.getElementById("submitBtn").disabled = true;
  }

  // 글 작성
  document.getElementById("submitBtn").addEventListener("click", async () => {
    const content = document.getElementById("postInput").value.trim();
    if (!content) return;

    await addDoc(postsRef, {
      content,
      timestamp: serverTimestamp()
    });

    localStorage.setItem(todayKey, "true");
    document.getElementById("submitBtn").disabled = true;
    document.getElementById("postInput").value = "";
    loadPosts(); // 작성 후 바로 리스트 갱신
  });

  // 글 불러오기 (최신순)
  async function loadPosts() {
    const q = query(postsRef, orderBy("timestamp", "desc"));
    const snapshot = await getDocs(q);
    const list = document.getElementById("postList");
    list.innerHTML = "";
    snapshot.forEach(doc => {
      const li = document.createElement("li");
      li.textContent = doc.data().content;
      list.appendChild(li);
    });
  }

  loadPosts();
</script>

</body>
</html>
